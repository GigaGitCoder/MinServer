# Документация протокола пакетов мессенджера

## Общая структура пакета

Все пакеты имеют единый заголовок, за которым следует специфичное для типа пакета содержимое (payload).

| Смещение | Размер | Тип     | Описание                                    |
|----------|--------|---------|---------------------------------------------|
| 0        | 4      | UInt32  | Длина пакета (включая заголовок и payload)  |
| 4        | 2      | UInt16  | ID типа пакета (PacketType)                 |
| 6        | *      | *       | Содержимое пакета (зависит от типа)         |

**Примечания:**
- Все числовые значения передаются в little-endian формате
- Строки кодируются как: `UInt16 (длина) + байты UTF-8`
- Минимальный размер пакета: 6 байт (пакеты без содержимого, например PING/PONG)

---

## Типы пакетов

### 0x0001 - PACKET_ERROR
**Направление:** Server → Client

Отправляется сервером при возникновении ошибки.

| Смещение | Размер | Тип    | Описание              |
|----------|--------|--------|-----------------------|
| 6        | 2      | UInt16 | Код ошибки (ErrorCode)|
| 8        | 2      | UInt16 | Длина сообщения       |
| 10       | *      | String | Текст ошибки          |

**Коды ошибок:**
- `1000` - AUTH_FAILED (Ошибка аутентификации)
- `1001` - USER_EXISTS (Пользователь уже существует)
- `1002` - INVALID_TOKEN (Неверный токен)
- `1003` - UNAUTHORIZED (Не авторизован)
- `1004` - USER_NOT_FOUND (Пользователь не найден)
- `2000` - DATABASE_ERROR (Ошибка базы данных)
- `3000` - INVALID_PACKET (Неверный пакет)

---

### 0x0002 - REGISTER_REQUEST
**Направление:** Client → Server

Запрос на регистрацию нового пользователя.

| Смещение | Размер | Тип    | Описание         |
|----------|--------|--------|------------------|
| 6        | 2      | UInt16 | Длина username   |
| 8        | *      | String | Username         |
| *        | 2      | UInt16 | Длина password   |
| *        | *      | String | Password         |

---

### 0x0003 - REGISTER_RESPONSE
**Направление:** Server → Client

Ответ на запрос регистрации.

| Смещение | Размер | Тип    | Описание                          |
|----------|--------|--------|-----------------------------------|
| 6        | 1      | UInt8  | Успех (1 = успешно, 0 = ошибка)   |
| 7        | 8      | Int64  | ID пользователя                   |
| 15       | 2      | UInt16 | Длина токена                      |
| 17       | *      | String | Токен аутентификации              |

---

### 0x0004 - LOGIN_REQUEST
**Направление:** Client → Server

Запрос на вход в систему.

| Смещение | Размер | Тип    | Описание         |
|----------|--------|--------|------------------|
| 6        | 2      | UInt16 | Длина username   |
| 8        | *      | String | Username         |
| *        | 2      | UInt16 | Длина password   |
| *        | *      | String | Password         |

---

### 0x0005 - LOGIN_RESPONSE
**Направление:** Server → Client

Ответ на запрос входа.

| Смещение | Размер | Тип    | Описание                          |
|----------|--------|--------|-----------------------------------|
| 6        | 1      | UInt8  | Успех (1 = успешно, 0 = ошибка)   |
| 7        | 8      | Int64  | ID пользователя                   |
| 15       | 2      | UInt16 | Длина токена                      |
| 17       | *      | String | Токен аутентификации              |

---

### 0x0006 - AUTH_TOKEN_REQUEST
**Направление:** Client → Server

Запрос аутентификации по токену (переподключение).

| Смещение | Размер | Тип    | Описание                |
|----------|--------|--------|-------------------------|
| 6        | 2      | UInt16 | Длина токена            |
| 8        | *      | String | Токен аутентификации    |

---

### 0x0007 - AUTH_RESPONSE
**Направление:** Server → Client

Ответ на аутентификацию по токену.

| Смещение | Размер | Тип    | Описание                          |
|----------|--------|--------|-----------------------------------|
| 6        | 1      | UInt8  | Успех (1 = успешно, 0 = ошибка)   |
| 7        | 8      | Int64  | ID пользователя                   |

---

### 0x0008 - SEND_MESSAGE
**Направление:** Client → Server

Отправка сообщения другому пользователю.

| Смещение | Размер | Тип    | Описание               |
|----------|--------|--------|------------------------|
| 6        | 8      | Int64  | ID получателя          |
| 14       | 2      | UInt16 | Длина сообщения        |
| 16       | *      | String | Текст сообщения        |

---

### 0x0009 - RECEIVE_MESSAGE
**Направление:** Server → Client

Получение сообщения от другого пользователя.

| Смещение | Размер | Тип    | Описание               |
|----------|--------|--------|------------------------|
| 6        | 8      | Int64  | ID сообщения           |
| 14       | 8      | Int64  | Timestamp (Unix time)  |
| 22       | 8      | Int64  | ID отправителя         |
| 30       | 8      | Int64  | ID получателя          |
| 38       | 2      | UInt16 | Длина сообщения        |
| 40       | *      | String | Текст сообщения        |

---

### 0x000A - HISTORY_REQUEST
**Направление:** Client → Server

Запрос истории сообщений с пользователем.

| Смещение | Размер | Тип    | Описание                          |
|----------|--------|--------|-----------------------------------|
| 6        | 8      | Int64  | ID собеседника (peer)             |
| 14       | 4      | UInt32 | Лимит сообщений                   |

---

### 0x000B - HISTORY_RESPONSE
**Направление:** Server → Client

Ответ с историей сообщений с указанным пользователем.

| Смещение | Размер | Тип    | Описание                          |
|----------|--------|--------|-----------------------------------|
| 6        | 4      | UInt32 | Количество сообщений              |

Далее для каждого сообщения:

| Смещение | Размер | Тип    | Описание               |
|----------|--------|--------|------------------------|
| *        | 8      | Int64  | ID сообщения           |
| *        | 8      | Int64  | Timestamp (Unix time)  |
| *        | 8      | Int64  | ID отправителя         |
| *        | 8      | Int64  | ID получателя          |
| *        | 2      | UInt16 | Длина сообщения        |
| *        | *      | String | Текст сообщения        |

**Пример структуры для 2 сообщений:**
- Заголовок (6 байт)
- Count: 2 (4 байта)
- Сообщение 1: messageId (8) + timestamp (8) + senderId (8) + recipientId (8) + textLen (2) + text
- Сообщение 2: messageId (8) + timestamp (8) + senderId (8) + recipientId (8) + textLen (2) + text

---

### 0x000C - USER_LIST_REQUEST
**Направление:** Client → Server

Запрос списка всех онлайн пользователей (кроме себя).

| Смещение | Размер | Тип    | Описание    |
|----------|--------|--------|-------------|
| 6        | 0      | -      | Нет payload |

**Примечание:** Запрос не требует параметров, сервер вернет всех подключенных пользователей.

---

### 0x000D - USER_LIST_RESPONSE
**Направление:** Server → Client

Ответ со списком пользователей и их статусами.

| Смещение | Размер | Тип    | Описание                |
|----------|--------|--------|-------------------------|
| 6        | 4      | UInt32 | Количество пользователей|

Далее для каждого пользователя:

| Смещение | Размер | Тип    | Описание                     |
|----------|--------|--------|------------------------------|
| *        | 8      | Int64  | ID пользователя              |
| *        | 2      | UInt16 | Длина username               |
| *        | *      | String | Username                     |
| *        | 1      | UInt8  | Статус (1 = онлайн, 0 = офлайн)|

**Примечание:** Текущая реализация возвращает только онлайн-пользователей.

---

### 0x000E - PING
**Направление:** Client → Server

Проверка соединения (keep-alive).

| Смещение | Размер | Тип    | Описание    |
|----------|--------|--------|-------------|
| 6        | 0      | -      | Нет payload |

---

### 0x000F - PONG
**Направление:** Server → Client

Ответ на PING.

| Смещение | Размер | Тип    | Описание    |
|----------|--------|--------|-------------|
| 6        | 0      | -      | Нет payload |

---

### 0x0010 - SEARCH_USERS_REQUEST
**Направление:** Client → Server

Поиск пользователей по имени (поддерживает частичное совпадение).

| Смещение | Размер | Тип    | Описание           |
|----------|--------|--------|--------------------|
| 6        | 2      | UInt16 | Длина запроса      |
| 8        | *      | String | Поисковый запрос   |

**Пример:** Поиск `"iva"` найдет пользователей `"ivan"`, `"ivanov"`, `"olivia"`.

---

### 0x0011 - SEARCH_USERS_RESPONSE
**Направление:** Server → Client

Результаты поиска пользователей.

| Смещение | Размер | Тип    | Описание                 |
|----------|--------|--------|--------------------------|
| 6        | 4      | UInt32 | Количество найденных     |

Далее для каждого найденного пользователя:

| Смещение | Размер | Тип    | Описание                     |
|----------|--------|--------|------------------------------|
| *        | 8      | Int64  | ID пользователя              |
| *        | 2      | UInt16 | Длина username               |
| *        | *      | String | Username                     |
| *        | 1      | UInt8  | Статус (1 = онлайн, 0 = офлайн)|

**Примечание:** Если пользователей не найдено, count = 0.

---

### 0x0012 - LOGOUT_REQUEST
**Направление:** Client → Server

Запрос на выход из системы (закрытие сессии).

| Смещение | Размер | Тип    | Описание    |
|----------|--------|--------|-------------|
| 6        | 0      | -      | Нет payload |

**Примечание:** После отправки клиент должен закрыть соединение. Сервер удалит пользователя из списка онлайн и разошлет `USER_STATUS_UPDATE`.

---

### 0x0013 - USER_STATUS_UPDATE
**Направление:** Server → Client

Broadcast-уведомление об изменении статуса пользователя (вход/выход).

| Смещение | Размер | Тип    | Описание                     |
|----------|--------|--------|------------------------------|
| 6        | 8      | Int64  | ID пользователя              |
| 14       | 1      | UInt8  | Статус (1 = онлайн, 0 = офлайн)|

**Примечание:** Отправляется всем онлайн-пользователям (кроме самого изменившего статус) при подключении или отключении клиента.

---

## Примеры использования

### Пример 1: Отправка сообщения

```cpp
// Клиент отправляет сообщение пользователю с ID 12345
SendMessagePacket packet(12345, "Привет!");
std::vector<uint8_t> data = packet.serialize();
// Отправка data через сокет...
```

### Пример 2: Обработка ошибки

```cpp
// Сервер отправляет ошибку аутентификации
ErrorPacket error(ErrorCode::AUTH_FAILED, "Неверный пароль");
std::vector<uint8_t> data = error.serialize();
// Отправка data клиенту...
```

### Пример 3: Регистрация пользователя

```cpp
// Клиент: Запрос регистрации
RegisterRequestPacket request("username", "password123");
auto data = request.serialize();

// Сервер: Успешный ответ
RegisterResponsePacket response(true, 1001, "auth_token_xyz");
auto responseData = response.serialize();
```

### Пример 4: Запрос истории сообщений

```cpp
// Клиент запрашивает 50 последних сообщений с пользователем 999
HistoryRequestPacket request(999, 50);
auto data = request.serialize();
// Отправка через сокет...

// Сервер отправляет историю
std::vector<ReceiveMessagePacket> messages = {
ReceiveMessagePacket(1, 1700000000, 123, 999, "Привет"),
ReceiveMessagePacket(2, 1700000060, 999, 123, "Здравствуй")
};
HistoryResponsePacket response(messages);
auto responseData = response.serialize();
```

### Пример 5: Поиск пользователей

```cpp
// Клиент ищет пользователей с именем, содержащим "alex"
SearchUsersRequestPacket request("alex");
auto data = request.serialize();

// Сервер возвращает найденных пользователей
std::vector<std::tuple<int64_t, std::string, bool>> results = {
{100, "alexander", true},
{101, "alexey", false}
};
SearchUsersResponsePacket response(results);
auto responseData = response.serialize();
```


### Пример 6: Обновление статуса

```cpp
// Сервер уведомляет всех о том, что пользователь 555 вышел из сети
UserStatusUpdatePacket update(555, false);
auto data = update.serialize();
// Broadcast всем подключенным клиентам...
```

### Пример 7: Список онлайн-пользователей

```cpp
// Клиент запрашивает список
UserListRequestPacket request;
auto data = request.serialize();

// Сервер отвечает списком
std::vector<std::tuple<int64_t, std::string, bool>> users = {
{10, "user1", true},
{20, "user2", true},
{30, "user3", true}
};
UserListResponsePacket response(users);
auto responseData = response.serialize();
```

---

## Утилиты сериализации

Класс `Packet` предоставляет статические методы для работы с примитивными типами:

| Метод             | Описание                                |
|-------------------|-----------------------------------------|
| `writeUint16()`   | Запись 2-байтового числа (little-endian)|
| `writeUint32()`   | Запись 4-байтового числа (little-endian)|
| `writeInt64()`    | Запись 8-байтового числа (little-endian)|
| `writeString()`   | Запись строки (length-prefixed)         |
| `readUint16()`    | Чтение 2-байтового числа                |
| `readUint32()`    | Чтение 4-байтового числа                |
| `readInt64()`     | Чтение 8-байтового числа                |
| `readString()`    | Чтение строки                           |

---

## PacketBuilder

Класс `PacketBuilder` упрощает создание пакетов через fluent-интерфейс:

```cpp
PacketBuilder builder(PacketType::SEND_MESSAGE);
builder.addInt64(recipientId)
       .addString("Сообщение")
       .build();
```

Автоматически:
- Резервирует место для заголовка (6 байт)
- Заполняет length и packetId при вызове `build()`
- Возвращает готовый буфер для отправки

---

## Версия протокола

Текущая версия: **1.0**

Данный протокол не включает версионирование в заголовок пакета. При внесении изменений рекомендуется добавить поле версии протокола в будущих итерациях.
